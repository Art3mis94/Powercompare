<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Compare Players â€” Power</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body{margin:0;font-family:Inter,sans-serif;background:#f8fafc;color:#1e293b;}
header{background:#1e40af;color:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;}
header h1{margin:0;font-size:1.5rem;font-weight:600;}
button.signOut{padding:.5rem 1rem;border-radius:6px;border:none;background:#3b82f6;color:#fff;cursor:pointer;}
button.signOut:hover{opacity:.9;}
nav{display:flex;justify-content:center;gap:10px;padding:.75rem;background:#e2e8f0;}
nav a{background:#3b82f6;color:#fff;padding:.6rem 1rem;border-radius:6px;text-decoration:none;font-weight:600;}
main{max-width:1200px;margin:1.5rem auto;padding:0 1rem;}
.section{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.04);}
.section h2{font-size:1.25rem;margin-bottom:1rem;}
.controls{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;}
.filter-group{display:flex;flex-direction:column;gap:.3rem;}
.filter-group label{font-weight:500;color:#475569;}
.filter-group select{padding:.5rem;border-radius:6px;border:1px solid #e2e8f0;background:#fff;color:#1e293b;}
.filter-group button{padding:.5rem 1rem;border-radius:6px;border:0;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer;}
.filter-group button:hover{background:#2563eb;}
.filter-group button#resetBtn{background:#6b7280;}
.filter-group button#resetBtn:hover{background:#4b5563;}
/* Chart container styling */
#chartContainer{
    position: relative;
    height: 400px; /* Define a height for the chart */
    width: 100%;
    margin-top: 1rem;
    padding: 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: #fdfdfe;
}
/* Overlay */
#overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;
  z-index:1000;
}
#overlay > div{
    max-width: 90%;
    max-height: 90%;
    overflow: auto;
}
#overlay table{background:#fff;color:#1e293b;border-collapse:collapse;border-radius:8px;overflow:hidden;min-width:400px;box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
#overlay th, #overlay td{padding:.8rem 1.2rem;border-bottom:1px solid #eee;text-align:center;}
#overlay th{background:#1e40af;color:#fff;position: sticky; top: 0;}
#overlay td.power-val{font-weight: 600;}
#overlay button{margin:.8rem;padding:.5rem 1rem;border:none;border-radius:6px;background:#ef4444;color:#fff;font-weight:600;cursor:pointer;}
</style>
</head>
<body>

<header>
  <h1>Compare Players</h1>
  <button id="signOutBtn" class="signOut">Sign Out</button>
</header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="power.html">Add / Edit Power</a>
</nav>

<main>
<section class="section">
  <h2>Comparison Setup</h2>
  <div class="controls">
    
    <div class="filter-group">
      <label for="playerSelect">Players</label>
      <select id="playerSelect" multiple size="8"></select>
    </div>
    
    <div class="filter-group">
        <label for="comparisonMethod">Chart Method</label>
        <select id="comparisonMethod">
            <option value="rawPower">Raw Power (Y-Axis: Total Power)</option>
            <option value="percentChange">Percent Change (Y-Axis: % Change)</option>
        </select>
    </div>

    <div class="filter-group">
      <label>&nbsp;</label>
      <button id="chartBtn">Generate Chart</button>
      <button id="compareBtn">Summary Table</button>
      <button id="resetBtn">Reset</button>
    </div>
  </div>
</section>

<section class="section" style="margin-top: 1.5rem;">
    <h2>Power Trend Chart</h2>
    <div id="chartContainer">
        <p id="chartStatus">Select players and click "Generate Chart" to view the trend.</p>
        <canvas id="powerChart" style="display:none;"></canvas>
    </div>
</section>
</main>

<div id="overlay">
  <div>
    <table id="compareTable"></table>
    <div style="text-align:center"><button id="closeOverlay">Close</button></div>
  </div>
</div>

<script>
// Firebase config (Use your actual configuration)
const firebaseConfig = {
  apiKey: "AIzaSyAyhGftf_DfotmvL4iLx60NT98BjkbG6DM",
  authDomain: "powercompare-bafd9.firebaseapp.com",
  projectId: "powercompare-bafd9",
  storageBucket: "powercompare-bafd9.firebasestorage.app",
  messagingSenderId: "768897803088",
  appId: "1:768897803088:web:ff55aed87037cef6720255",
  measurementId: "G-09ENH5L0VG"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Global variable to store all player entries once loaded
let allPlayerEntries = {}; 

// Utility function to format numbers with commas
const formatNumber = (num) => {
    // Check if the number is an integer (for power values)
    if (Number.isInteger(num)) {
        return num.toLocaleString();
    }
    // For percentages, keep the precision
    return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};

// Redirect if not logged in
auth.onAuthStateChanged(user=>{
    if(!user) {
        location.href="login.html";
    } else {
        loadAllPlayerEntries();
    }
});

// Sign out
document.getElementById("signOutBtn").onclick = ()=> auth.signOut().then(()=>location.href="login.html");

/**
 * Loads all entries for the current user and populates the player selection list.
 */
async function loadAllPlayerEntries(){
    document.getElementById('chartStatus').textContent = 'Loading player data...';
    const user = auth.currentUser;
    if (!user) return; 

    const snapshot = await db.collection('powers').doc(user.uid).collection('entries')
                             .orderBy('date', 'asc').get();
    
    const players = {};
    snapshot.forEach(doc => {
        const data = doc.data();
        const date = data.date ? data.date : new Date().toISOString(); 
        
        if (!players[data.name]) players[data.name] = [];
        players[data.name].push({
            power: data.power,
            date: date
        });
    });

    allPlayerEntries = players;
    populatePlayers();
    document.getElementById('chartStatus').textContent = 'Select players and click "Generate Chart" to view the trend.';
}

/**
 * Populates the player select element from the loaded data.
 */
function populatePlayers(){
    const playerNames = Object.keys(allPlayerEntries).sort();
    const select = document.getElementById('playerSelect');
    
    if (playerNames.length === 0) {
        select.innerHTML = '<option disabled>No players found</option>';
        document.getElementById('chartBtn').disabled = true;
        document.getElementById('compareBtn').disabled = true;
        return;
    }
    
    select.innerHTML = playerNames.map(p => `<option value="${p}">${p}</option>`).join('');
    document.getElementById('chartBtn').disabled = false;
    document.getElementById('compareBtn').disabled = false;
}

/**
 * Generates and shows the summary comparison data in the overlay table.
 */
function showOverlay(){
    const selectedNames = [...document.getElementById('playerSelect').options]
                           .filter(o => o.selected)
                           .map(o => o.value);
    
    if(selectedNames.length < 2){ 
        alert('Select at least 2 players to compare.'); 
        return; 
    }

    const table = document.getElementById('compareTable');
    table.innerHTML = `
        <tr>
            <th>Player</th>
            <th>Current Power</th>
            <th>Previous Power</th>
            <th>% Change</th>
        </tr>
    `;
    
    let topPower = 0;
    const comparisonRows = [];

    selectedNames.forEach(name => {
        const entries = allPlayerEntries[name];
        if(!entries || entries.length === 0) return;

        const latestEntry = entries[entries.length - 1];
        const previousEntry = entries.length > 1 ? entries[entries.length - 2] : latestEntry;
        
        const currentPower = latestEntry.power;
        const previousPower = previousEntry.power;

        // Calculate percent change, handling division by zero for new players
        const change = previousPower ? ((currentPower - previousPower) / previousPower * 100) : 0;
        
        if(currentPower > topPower) topPower = currentPower;
        
        comparisonRows.push({ name, currentPower, previousPower, change });
    });

    // Generate table rows
    comparisonRows.forEach(r => {
        const changeColor = r.change >= 0 ? 'color:green' : 'color:red';
        
        table.innerHTML += `
            <tr>
                <td>${r.name}</td>
                <td class="power-val">${formatNumber(r.currentPower)}</td>
                <td>${formatNumber(r.previousPower)}</td>
                <td style="${changeColor}">${r.change >= 0 ? '+' : ''}${formatNumber(r.change)}%</td>
            </tr>
        `;
    });

    document.getElementById('overlay').style.display = 'flex';
}

/**
 * Prepares data and calls a charting function (placeholder).
 */
function generateChart(){
    const selectedNames = [...document.getElementById('playerSelect').options]
                           .filter(o => o.selected)
                           .map(o => o.value);
    const method = document.getElementById('comparisonMethod').value;

    if(selectedNames.length === 0){ 
        alert('Select at least one player to generate a chart.'); 
        return; 
    }
    
    // --- Data Preparation ---
    const chartData = {};
    let allDates = new Set();
    
    selectedNames.forEach(name => {
        const entries = allPlayerEntries[name];
        if(!entries || entries.length === 0) return;
        
        // Ensure dates are used as keys for merging datasets
        const playerSeries = entries.reduce((acc, entry) => {
            const dateKey = entry.date.substring(0, 10); // Use YYYY-MM-DD for consistency
            allDates.add(dateKey);
            acc[dateKey] = entry.power;
            return acc;
        }, {});
        chartData[name] = playerSeries;
    });

    if (Object.keys(chartData).length === 0) {
        alert('No data available for the selected players.');
        return;
    }
    
    const sortedDates = Array.from(allDates).sort();

    // The function below is a placeholder. You would replace this with actual 
    // chart rendering code using a library like Chart.js, D3.js, etc.
    renderChartPlaceholder(sortedDates, chartData, method);
}

/**
 * PLACEHOLDER FUNCTION: This function simulates chart generation.
 * You MUST replace this with a real charting library implementation.
 */
function renderChartPlaceholder(dates, data, method){
    const canvas = document.getElementById('powerChart');
    const status = document.getElementById('chartStatus');
    
    // In a real implementation, you'd initialize a Chart.js object here.
    // For example:
    // const ctx = canvas.getContext('2d');
    // new Chart(ctx, { ... data and config based on 'method' ... });

    // Placeholder text update:
    status.style.display = 'block';
    canvas.style.display = 'none';
    
    let chartTitle = method === 'rawPower' ? 'Raw Power Over Time' : 'Percent Change Over Time';
    let yAxisLabel = method === 'rawPower' ? 'Power Value' : 'Percent Change (%)';
    
    status.innerHTML = `
        <h3>${chartTitle}</h3>
        <p>Chart generation logic goes here. The method selected is: <strong>${method}</strong>.</p>
        <p>The **X-Axis** would be **Date**.</p>
        <p>The **Y-Axis** would represent the **${yAxisLabel}**.</p>
        <p>The data points ready to be charted are for dates: ${dates.join(', ')}</p>
        <p>To implement this, you'll need to include a charting library (e.g., Chart.js) and write the code to draw lines based on the prepared <code>dates</code> and <code>data</code> variables, adjusting the Y-axis scale based on the <code>method</code>.</p>
    `;
    
    // Example of showing the canvas placeholder for styling purposes:
    // canvas.style.display = 'block'; 
}


// Event listeners
document.getElementById('compareBtn').onclick = showOverlay; // Summary Table button
document.getElementById('chartBtn').onclick = generateChart; // Generate Chart button
document.getElementById('resetBtn').onclick = ()=>{
    [...document.getElementById('playerSelect').options].forEach(o=>o.selected=false);
};
document.getElementById('closeOverlay').onclick = ()=>document.getElementById('overlay').style.display='none';
</script>

</body>
</html>
