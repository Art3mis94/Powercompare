<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Player Dashboard — Power Tracker (Local)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body {
    font-family: Inter,sans-serif;
    margin:0;
    background:#f8fafc;
    color:#1e293b;
}
header {
    background:#1e40af;
    color:#fff;
    padding:1rem 1.5rem;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
header h1 { margin:0; font-size:1.25rem; }
button { padding:.5rem 1rem; border-radius:6px; border:none; background:#3b82f6; color:#fff; cursor:pointer; }
button:hover { opacity:.9; }
nav { display:flex; justify-content:center; gap:10px; padding:.75rem; background:#e2e8f0; }
nav a { background:#3b82f6; color:#fff; padding:.6rem 1rem; border-radius:6px; text-decoration:none; font-weight:600; }
nav a:hover { opacity:.9; }
main { max-width:900px; margin:1.5rem auto; padding:0 1rem; }
table { width:100%; border-collapse:collapse; margin-top:1rem; }
th, td { padding:.6rem; border-bottom:1px solid #ccc; text-align:left; }
tr.selected { background:rgba(59,130,246,0.2); cursor:pointer; }

/* Overlay Styles */
#overlay {
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.5);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1000;
}
#overlay > div {
    max-width:90%;
    max-height:90%;
    overflow:auto;
    background:#fff;
    padding:1.5rem;
    border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,0.3);
}
#overlay table {
    width:100%;
    border-collapse:collapse;
    margin-top:1rem;
}
#overlay th, #overlay td {
    padding:.8rem 1rem;
    text-align:center;
    border-bottom:1px solid #eee;
}
#overlay th {
    background:#1e40af;
    color:#fff;
    position:sticky;
    top:0;
}
#overlay td.positive { color:#10b981; font-weight:600; }
#overlay td.negative { color:#ef4444; font-weight:600; }
#overlay button {
    margin-top:1rem;
    padding:.6rem 1.2rem;
    border:none;
    border-radius:6px;
    background:#ef4444;
    color:#fff;
    font-weight:600;
    cursor:pointer;
}
</style>
</head>
<body>

<header>
  <h1>Player Dashboard</h1>
  </header>

<nav>
  <a href="./index.html">Dashboard</a>
  <a href="./compare.html">Compare</a>
  <a href="./power.html">Add / Edit Power</a>
</nav>

<main>
  <p style="text-align:center; font-style:italic; color:#64748b;">Data is stored locally in your browser.</p>
  <table id="playerTable">
    <thead>
      <tr>
        <th>Player</th>
        <th>Latest Power</th>
        <th>% Change (7-Day)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div style="margin-top:1rem;">
    <button id="showOverlayBtn">View Performance Overview</button>
  </div>
</main>

<div id="overlay">
  <div>
    <h2 style="margin-top:0; text-align:center; color:#1e40af;">Player Performance Overview</h2>
    <table id="compareTable">
      <thead>
        <tr>
          <th>Player</th>
          <th>Latest Power</th>
          <th>7-Day Growth</th>
          <th>Trend</th>
          <th>Avg Daily Gain</th>
          <th>Rank</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="text-align:center;">
      <button id="closeOverlay">Close</button>
    </div>
  </div>
</div>

<script>
// Key for localStorage
const LOCAL_STORAGE_KEY = 'localPowerTrackerData';

// Mock data structure to initialize localStorage if empty
const initialData = [
  // Example data entry: { player: 'Player Name', power: 123456, date: 'YYYY-MM-DD' }
  { player: 'Alpha', power: 150000, date: '2025-12-02' },
  { player: 'Alpha', power: 175000, date: '2025-12-09' },
  { player: 'Beta', power: 120000, date: '2025-12-02' },
  { player: 'Beta', power: 140000, date: '2025-12-09' },
  { player: 'Gamma', power: 200000, date: '2025-12-05' },
  { player: 'Gamma', power: 195000, date: '2025-12-09' },
];

let allEntriesData = {};

// Elements
const playerTableBody = document.querySelector('#playerTable tbody');
const showOverlayBtn = document.getElementById('showOverlayBtn');
const overlay = document.getElementById('overlay');
const compareTableBody = document.querySelector('#compareTable tbody');
const closeOverlayBtn = document.getElementById('closeOverlay');

/**
 * Loads data from localStorage, initializes if empty, and groups by player.
 * @returns {Array} The loaded and parsed array of power entries.
 */
function loadLocalData() {
  const dataString = localStorage.getItem(LOCAL_STORAGE_KEY);
  if (!dataString) {
    // Initialize with mock data if no data exists
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(initialData));
    return initialData;
  }
  return JSON.parse(dataString);
}

/**
 * Groups raw entries into an object keyed by player name.
 * @param {Array} entries - The raw array of power entries.
 */
function groupEntries(entries) {
  const grouped = {};
  entries.forEach(entry => {
    if (!grouped[entry.player]) grouped[entry.player] = [];
    // Ensure 'date' is a string for sorting consistency
    entry.date = entry.date.substring(0, 10);
    grouped[entry.player].push(entry);
  });
  return grouped;
}

/**
 * Calculates the 7-day power change for a player's entries.
 * @param {Array} entries - Sorted array of a player's power entries.
 * @returns {number} The percentage change.
 */
function calculateSevenDayChange(entries) {
  if (entries.length === 0) return 0;

  const latest = entries[entries.length - 1];
  const latestDate = new Date(latest.date);
  const sevenDaysAgo = new Date(latestDate);
  sevenDaysAgo.setDate(latestDate.getDate() - 7);

  // Find the entry that is the earliest one within the last 7 days (or the first entry ever)
  let earliestPowerEntry = entries.find(e => new Date(e.date) >= sevenDaysAgo);
  
  if (!earliestPowerEntry || earliestPowerEntry === latest) {
    // If only one entry in the last 7 days (or no entry older than 7 days), 
    // fall back to the very first entry if available, or just the latest itself.
    if (entries.length > 1) {
        earliestPowerEntry = entries[0];
    } else {
        return 0; // Only one entry ever
    }
  }

  const earliestPower = earliestPowerEntry.power;
  const latestPower = latest.power;

  if (earliestPower === 0) return 0;
  return ((latestPower - earliestPower) / earliestPower) * 100;
}

/**
 * Renders the main player dashboard table.
 */
function renderPlayerTable() {
  const rawData = loadLocalData();
  allEntriesData = groupEntries(rawData);
  playerTableBody.innerHTML = ''; // Clear existing rows

  Object.entries(allEntriesData).forEach(([name, entries]) => {
    // Sort entries by date for reliable 'latest' calculation
    entries.sort((a, b) => new Date(a.date) - new Date(b.date));
    const latest = entries[entries.length - 1];
    
    // Calculate 7-day change
    const change = calculateSevenDayChange(entries);

    const tr = document.createElement('tr');
    tr.dataset.name = name;
    tr.innerHTML = `
      <td>${name}</td>
      <td>${latest.power.toLocaleString()}</td>
      <td style="color:${change >= 0 ? '#10b981' : '#ef4444'}">${change.toFixed(2)}%</td>
    `;
    tr.onclick = () => tr.classList.toggle('selected');
    playerTableBody.appendChild(tr);
  });
}

/**
 * Calculates and renders the performance overview in the overlay.
 */
function renderPerformanceOverview() {
  const selected = [...playerTableBody.querySelectorAll('tr.selected')].map(tr => tr.dataset.name);
  if (selected.length === 0) return alert("Select at least 1 player to view the overview.");

  compareTableBody.innerHTML = '';
  
  const overviewData = selected.map(name => {
    const entries = allEntriesData[name];
    entries.sort((a, b) => new Date(a.date) - new Date(b.date));
    const latest = entries[entries.length - 1];

    const latestDate = new Date(latest.date);
    const sevenDaysAgo = new Date(latestDate); 
    sevenDaysAgo.setDate(latestDate.getDate() - 7);
    
    // Entries within the last 7 days (including the latest)
    const lastWeekEntries = entries.filter(e => new Date(e.date) >= sevenDaysAgo);
    
    // Earliest entry used for the growth calculation (might be the very first entry if data is sparse)
    const earliestPowerEntry = lastWeekEntries.length > 0 ? lastWeekEntries[0] : latest; 
    
    const growth = earliestPowerEntry.power ? ((latest.power - earliestPowerEntry.power) / earliestPowerEntry.power * 100) : 0;
    const trend = growth > 0 ? '⬆️' : (growth < 0 ? '⬇️' : '→');
    
    // Calculate Avg Daily Gain based on the actual date span of the recorded entries
    let avgGain = 0;
    if (lastWeekEntries.length > 1) {
      const firstDate = new Date(lastWeekEntries[0].date);
      const lastDate = new Date(lastWeekEntries[lastWeekEntries.length-1].date);
      const days = (lastDate - firstDate) / 86400000; // milliseconds in a day

      if (days > 0) {
        avgGain = (latest.power - earliestPowerEntry.power) / days;
      }
    }

    return { name, latest: latest.power, growth, trend, avgGain };
  });

  // Sort by latest power for ranking
  overviewData.sort((a, b) => b.latest - a.latest).forEach((d, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.name}</td>
      <td>${d.latest.toLocaleString()}</td>
      <td class="${d.growth >= 0 ? 'positive' : 'negative'}">${d.growth.toFixed(2)}%</td>
      <td>${d.trend}</td>
      <td>${d.avgGain.toFixed(1)}</td>
      <td>${i + 1}</td>
    `;
    compareTableBody.appendChild(tr);
  });

  overlay.style.display = 'flex';
}

// Initial load
document.addEventListener('DOMContentLoaded', renderPlayerTable);

// Event Listeners
showOverlayBtn.onclick = renderPerformanceOverview;
closeOverlayBtn.onclick = () => overlay.style.display = 'none';

</script>
</body>
</html>
