<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Player Dashboard — Power Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body {
    font-family: Inter,sans-serif;
    margin:0;
    background:#f8fafc;
    color:#1e293b;
}
header {
    background:#1e40af;
    color:#fff;
    padding:1rem 1.5rem;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
header h1 { margin:0; font-size:1.25rem; }
button { padding:.5rem 1rem; border-radius:6px; border:none; background:#3b82f6; color:#fff; cursor:pointer; }
button:hover { opacity:.9; }
nav { display:flex; justify-content:center; gap:10px; padding:.75rem; background:#e2e8f0; }
nav a { background:#3b82f6; color:#fff; padding:.6rem 1rem; border-radius:6px; text-decoration:none; font-weight:600; }
nav a:hover { opacity:.9; }
main { max-width:900px; margin:1.5rem auto; padding:0 1rem; }
table { width:100%; border-collapse:collapse; margin-top:1rem; }
th, td { padding:.6rem; border-bottom:1px solid #ccc; text-align:left; }
tr.selected { background:rgba(59,130,246,0.2); cursor:pointer; }

/* Overlay Styles */
#overlay {
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.5);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1000;
}
#overlay > div {
    max-width:90%;
    max-height:90%;
    overflow:auto;
    background:#fff;
    padding:1.5rem;
    border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,0.3);
}
#overlay table {
    width:100%;
    border-collapse:collapse;
    margin-top:1rem;
}
#overlay th, #overlay td {
    padding:.8rem 1rem;
    text-align:center;
    border-bottom:1px solid #eee;
}
#overlay th {
    background:#1e40af;
    color:#fff;
    position:sticky;
    top:0;
}
#overlay td.positive { color:#10b981; font-weight:600; }
#overlay td.negative { color:#ef4444; font-weight:600; }
#overlay button {
    margin-top:1rem;
    padding:.6rem 1.2rem;
    border:none;
    border-radius:6px;
    background:#ef4444;
    color:#fff;
    font-weight:600;
    cursor:pointer;
}
</style>
</head>
<body>

<header>
  <h1>Player Dashboard</h1>
  <button id="signOutBtn">Sign Out</button>
</header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="compare.html">Compare</a>
  <a href="power.html">Add / Edit Power</a>
</nav>

<main>
  <table id="playerTable">
    <thead>
      <tr>
        <th>Player</th>
        <th>Latest Power</th>
        <th>% Change (7-Day)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div style="margin-top:1rem;">
    <button id="showOverlayBtn">View Performance Overview</button>
  </div>
</main>

<!-- Overlay for Player Stats -->
<div id="overlay">
  <div>
    <h2 style="margin-top:0; text-align:center; color:#1e40af;">Player Performance Overview</h2>
    <table id="compareTable">
      <thead>
        <tr>
          <th>Player</th>
          <th>Latest Power</th>
          <th>7-Day Growth</th>
          <th>Trend</th>
          <th>Avg Daily Gain</th>
          <th>Rank</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div style="text-align:center;">
      <button id="closeOverlay">Close</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAyhGftf_DfotmvL4iLx60NT98BjkbG6DM",
  authDomain: "powercompare-bafd9.firebaseapp.com",
  projectId: "powercompare-bafd9",
  storageBucket: "powercompare-bafd9.firebasestorage.app",
  messagingSenderId: "768897803088",
  appId: "1:768897803088:web:ff55aed87037cef6720255",
  measurementId: "G-09ENH5L0VG"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let uid = null;
let allEntriesData = {};

// Elements
const playerTableBody = document.querySelector('#playerTable tbody');
const showOverlayBtn = document.getElementById('showOverlayBtn');
const overlay = document.getElementById('overlay');
const compareTableBody = document.querySelector('#compareTable tbody');

auth.onAuthStateChanged(user => {
  if(!user) return window.location.href = "login.html";
  uid = user.uid;
  loadPlayers();
});

document.getElementById('signOutBtn').onclick = ()=> auth.signOut().then(()=>location.href="login.html");

// Load players and latest power
function loadPlayers(){
  db.collection("powers").doc(uid).collection("entries")
    .orderBy("player", "asc")
    .orderBy("date", "asc")
    .onSnapshot(snapshot=>{
      allEntriesData = {};
      playerTableBody.innerHTML = '';

      snapshot.forEach(doc=>{
        const data = doc.data();
        data.id = doc.id;
        if(!allEntriesData[data.player]) allEntriesData[data.player] = [];
        allEntriesData[data.player].push(data);
      });

      // Render table
      Object.entries(allEntriesData).forEach(([name, entries])=>{
        entries.sort((a,b)=>new Date(a.date)-new Date(b.date));
        const latest = entries[entries.length-1];
        const sevenDaysAgo = new Date(latest.date);
        sevenDaysAgo.setDate(sevenDaysAgo.getDate()-7);
        const lastWeekEntries = entries.filter(e=>new Date(e.date)>=sevenDaysAgo);
        const earliest = lastWeekEntries[0] || latest;
        const change = earliest.power ? ((latest.power-earliest.power)/earliest.power*100) : 0;

        const tr = document.createElement('tr');
        tr.dataset.name = name;
        tr.innerHTML = `
          <td>${name}</td>
          <td>${latest.power.toLocaleString()}</td>
          <td style="color:${change>=0?'#10b981':'#ef4444'}">${change.toFixed(2)}%</td>
        `;
        tr.onclick = ()=> tr.classList.toggle('selected');
        playerTableBody.appendChild(tr);
      });
    });
}

// Overlay
showOverlayBtn.onclick = ()=>{
  const selected = [...playerTableBody.querySelectorAll('tr.selected')].map(tr=>tr.dataset.name);
  if(selected.length === 0) return alert("Select at least 1 player");

  compareTableBody.innerHTML = '';
  const overviewData = selected.map(name=>{
    const entries = allEntriesData[name];
    entries.sort((a,b)=>new Date(a.date)-new Date(b.date));
    const latest = entries[entries.length-1];
    const sevenDaysAgo = new Date(latest.date); sevenDaysAgo.setDate(sevenDaysAgo.getDate()-7);
    const lastWeekEntries = entries.filter(e=>new Date(e.date)>=sevenDaysAgo);
    const earliest = lastWeekEntries[0] || latest;
    const growth = earliest.power ? ((latest.power-earliest.power)/earliest.power*100) : 0;
    const trend = growth>0?'⬆️':(growth<0?'⬇️':'→');
    const days = lastWeekEntries.length>1?(new Date(lastWeekEntries[lastWeekEntries.length-1].date)-new Date(lastWeekEntries[0].date))/86400000:1;
    const avgGain = days>0?(latest.power-earliest.power)/days:0;
    return {name, latest:latest.power, growth, trend, avgGain};
  });

  overviewData.sort((a,b)=>b.latest-a.latest).forEach((d,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.name}</td>
      <td>${d.latest.toLocaleString()}</td>
      <td style="color:${d.growth>=0?'#10b981':'#ef4444'}">${d.growth.toFixed(2)}%</td>
      <td>${d.trend}</td>
      <td>${d.avgGain.toFixed(1)}</td>
      <td>${i+1}</td>
    `;
    compareTableBody.appendChild(tr);
  });

  overlay.style.display='flex';
};

document.getElementById('closeOverlay').onclick = ()=> overlay.style.display='none';
</script>
</body>
</html>