<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Player Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Inter,sans-serif;margin:0;background:#f8fafc;color:#1e293b;}
header{background:#1e40af;color:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;}
header h1{margin:0;font-size:1.25rem;}
button{padding:.5rem 1rem;border-radius:6px;border:none;background:#3b82f6;color:#fff;cursor:pointer;}
button:hover{opacity:.9;}
nav{display:flex;justify-content:center;gap:10px;padding:.75rem;background:#e2e8f0;}
nav a{background:#3b82f6;color:#fff;padding:.6rem 1rem;border-radius:6px;text-decoration:none;font-weight:600;}
nav a:hover{opacity:.9;}
main{max-width:900px;margin:1.5rem auto;padding:0 1rem;}
table{width:100%;border-collapse:collapse;margin-top:1rem;}
th,td{padding:.6rem;border-bottom:1px solid #ccc;text-align:left;}
td.percent{text-align:right;}
tr.selected{background:rgba(59,130,246,0.2);}
.overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;
  visibility:hidden;opacity:0;transition:opacity .3s;
}
.overlay .content{
  background:#fff;padding:1.5rem;border-radius:12px;max-width:500px;width:90%;
}
.overlay.visible{visibility:visible;opacity:1;}
</style>
</head>
<body>

<header>
  <h1>Player Dashboard</h1>
  <button id="signOutBtn">Sign Out</button>
</header>

<nav>
  <a href="power.html">Add / Edit Power</a>
  <a href="compare.html">Compare Players</a>
</nav>

<main>
  <table id="playerTable">
    <thead>
      <tr>
        <th>Player</th>
        <th>Previous Power</th>
        <th>Current Power</th>
        <th>% Change</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<div class="overlay" id="compareOverlay">
  <div class="content">
    <h3>Comparison</h3>
    <div id="comparisonResult"></div>
    <button onclick="closeOverlay()">Close</button>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAyhGftf_DfotmvL4iLx60NT98BjkbG6DM",
  authDomain: "powercompare-bafd9.firebaseapp.com",
  projectId: "powercompare-bafd9",
  storageBucket: "powercompare-bafd9.firebasestorage.app",
  messagingSenderId: "768897803088",
  appId: "1:768897803088:web:ff55aed87037cef6720255",
  measurementId: "G-09ENH5L0VG"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Redirect if not logged in
auth.onAuthStateChanged(user=>{
  if(!user) location.href="login.html";
  else loadPlayers();
});

// Sign out
document.getElementById("signOutBtn").onclick = ()=> auth.signOut().then(()=>location.href="login.html");

let selectedPlayers = [];

async function loadPlayers(){
  const user = auth.currentUser;
  const tbody = document.querySelector("#playerTable tbody");
  tbody.innerHTML = '';
  
  if (!user) return; 

  // Fetch all entries, ordered by player and date
  // Uses the stable path: /powers/{uid}/entries
  const snapshot = await db.collection('powers').doc(user.uid).collection('entries')
                           .orderBy('player', 'asc')
                           .orderBy('date', 'asc') 
                           .get();

  const playerEntries = {}; // {playerName: {date: maxPower, date: maxPower, ...}}

  // 1. Group entries by player and find the HIGHEST power for each unique date
  snapshot.forEach(doc=>{
    const d = doc.data();
    const name = d.player; // ðŸ’¡ CORRECT: Accessing the 'player' field
    const date = d.date.substring(0, 10); // Standardize date format

    if(!playerEntries[name]) playerEntries[name] = {};
    
    // Store the maximum power recorded for that specific date
    playerEntries[name][date] = Math.max(playerEntries[name][date] || 0, d.power);
  });

  // 2. Calculate and render stats for each player
  Object.entries(playerEntries).forEach(([name, datedPowers])=>{
    const dates = Object.keys(datedPowers).sort();

    // Get the two most recent unique dates
    const latestDate = dates[dates.length - 1];
    const previousDate = dates.length > 1 ? dates[dates.length - 2] : null;

    const curr = datedPowers[latestDate];
    const prev = previousDate ? datedPowers[previousDate] : 0;
    
    // Calculate Change
    const change = prev > 0 ? ((curr - prev) / prev * 100) : (curr > 0 ? Infinity : 0);
    const changeDisplay = change === Infinity ? '+âˆž%' : `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${name}</td>
      <td>${prev.toLocaleString()}</td>
      <td>${curr.toLocaleString()}</td>
      <td class="percent">${changeDisplay}</td>
    `;
    tr.onclick = ()=> selectPlayer(tr, name, prev, curr);
    tbody.appendChild(tr);
  });
}

// Click to select for comparison
function selectPlayer(tr, name, prev, curr){
  if(selectedPlayers.find(p=>p.name===name)){
    selectedPlayers = selectedPlayers.filter(p=>p.name!==name);
    tr.classList.remove('selected');
  } else {
    selectedPlayers.push({name, prev, curr});
    tr.classList.add('selected');
  }

  // Automatically show comparison overlay if two or more players are selected
  if(selectedPlayers.length>1) showOverlay();
}

// Show overlay
function showOverlay(){
  const overlay = document.getElementById("compareOverlay");
  const container = document.getElementById("comparisonResult");
  container.innerHTML = selectedPlayers.map(p=>{
    const change = p.prev > 0 ? ((p.curr - p.prev) / p.prev * 100) : (p.curr > 0 ? Infinity : 0);
    const changeDisplay = change === Infinity ? '+âˆž%' : `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
    return `<p><strong>${p.name}</strong>: Current=${p.curr.toLocaleString()}, Previous=${p.prev.toLocaleString()}, Change=${changeDisplay}</p>`;
  }).join('');
  overlay.classList.add("visible");
}

// Close overlay
function closeOverlay(){
  selectedPlayers = [];
  document.querySelectorAll("#playerTable tr").forEach(tr=>tr.classList.remove('selected'));
  document.getElementById("compareOverlay").classList.remove("visible");
}
</script>
</body>
</html>
