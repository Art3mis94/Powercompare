<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Player Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: Inter, sans-serif; margin:0; background:#f8fafc; color:#1e293b; }
header { background:#1e40af; color:#fff; padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center; }
header h1 { margin:0; font-size:1.25rem; }
header button { background:#ef4444; color:#fff; border:none; padding:.5rem 1rem; border-radius:6px; cursor:pointer; font-weight:600; }
main { max-width:900px; margin:1.25rem auto; padding:0 1rem; }
table { width:100%; border-collapse:collapse; margin-top:1rem; }
th, td { padding:.6rem .8rem; text-align:left; border-bottom:1px solid #ccc; }
th { background:#e2e8f0; }
td.percent { text-align:right; }
.top { font-weight:700; color:#059669; }
.increase { color:#059669; font-weight:600; }
.decrease { color:#dc2626; font-weight:600; }
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<header>
  <h1>Player Dashboard</h1>
  <button id="signOutBtn">Sign Out</button>
</header>

<main>
  <table id="playerTable">
    <thead>
      <tr>
        <th>Player</th>
        <th>Previous Power</th>
        <th>Current Power</th>
        <th>% Change</th>
        <th>% Relative to Top</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5" style="text-align:center;color:#555">Loading...</td></tr>
    </tbody>
  </table>
</main>

<script>
// Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAyhGftf_DfotmvL4iLx60NT98BjkbG6DM",
  authDomain: "powercompare-bafd9.firebaseapp.com",
  projectId: "powercompare-bafd9",
  storageBucket: "powercompare-bafd9.firebasestorage.app",
  messagingSenderId: "768897803088",
  appId: "1:768897803088:web:ff55aed87037cef6720255",
  measurementId: "G-09ENH5L0VG"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Redirect if not logged in
auth.onAuthStateChanged(user => {
  if(!user){
    window.location.href = "login.html";
  } else {
    loadData(user.uid);
  }
});

// Sign Out
document.getElementById("signOutBtn").addEventListener("click", () => {
  auth.signOut().then(() => window.location.href="login.html");
});

// Format numbers with commas
function formatNumber(num){
  return num.toLocaleString();
}

// Format percentage
function formatPercent(val){
  return val.toFixed(2) + "%";
}

// Load data from Firestore for this user
async function loadData(uid){
  const snapshot = await db.collection('powers').doc(uid).collection('entries').get();
  const data = snapshot.docs.map(doc => doc.data());

  renderTable(data);
}

function renderTable(data){
  const tableBody = document.querySelector('#playerTable tbody');
  tableBody.innerHTML = '';

  if(!data.length){
    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#555">No entries yet</td></tr>';
    return;
  }

  // Group by player
  const players = {};
  data.forEach(d=>{
    if(!players[d.name]) players[d.name]=[];
    players[d.name].push(d);
  });

  // Find top power
  let topPower = 0;
  for(const name in players){
    players[name].sort((a,b)=> new Date(a.date) - new Date(b.date));
    const latest = players[name][players[name].length-1];
    if(latest.power>topPower) topPower = latest.power;
  }

  // Build rows
  const rows = [];
  for(const name in players){
    const entries = players[name];
    const latest = entries[entries.length-1];
    const prev = entries.length>1 ? entries[entries.length-2] : null;
    const change = prev ? ((latest.power - prev.power)/prev.power*100) : 0;
    const relative = topPower ? (latest.power / topPower * 100) : 0;

    rows.push(`
      <tr>
        <td>${name}</td>
        <td>${prev ? formatNumber(prev.power) : '-'}</td>
        <td>${formatNumber(latest.power)}</td>
        <td class="percent ${change>=0?'increase':'decrease'}">${change>=0?'+':''}${formatPercent(change)}</td>
        <td class="percent">${formatPercent(relative)}</td>
      </tr>
    `);
  }

  // Sort by current power descending
  tableBody.innerHTML = rows.sort((a,b)=>{
    const pa = parseFloat(a.match(/<td>([\d,]+)<\/td>/g)[2].replace(/,/g,''));
    const pb = parseFloat(b.match(/<td>([\d,]+)<\/td>/g)[2].replace(/,/g,''));
    return pb-pa;
  }).join('');
}
</script>
</body>
</html>