<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Power Tracker Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        body { margin: 0; font-family: Inter, sans-serif; background: #f8fafc; color: #1e293b; }
        header { background: #1e40af; color: #fff; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.5rem; font-weight: 600; }
        button.signOut { padding: .5rem 1rem; border-radius: 6px; border: none; background: #3b82f6; color: #fff; cursor: pointer; }
        button.signOut:hover { opacity: .9; }
        nav { display: flex; justify-content: center; gap: 10px; padding: .75rem; background: #e2e8f0; }
        nav a { background: #3b82f6; color: #fff; padding: .6rem 1rem; border-radius: 6px; text-decoration: none; font-weight: 600; }
        main { max-width: 900px; margin: 1.5rem auto; padding: 0 1rem; }
        .section { background: #fff; padding: 1rem; border-radius: 12px; box-shadow: 0 6px 20px rgba(2,6,23,0.04); }
        .section h2 { font-size: 1.25rem; margin-bottom: 1rem; }
        .leaderboard table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .leaderboard th, .leaderboard td { padding: 0.8rem 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .leaderboard th { background: #f1f5f9; font-weight: 600; color: #475569; }
        .leaderboard tr:last-child td { border-bottom: none; }
        .leaderboard td.rank { width: 50px; font-weight: 700; color: #3b82f6; text-align: center;}
        .leaderboard td.power-val { font-weight: 700; color: #1e293b; }
        #loadingMessage { text-align: center; color: #475569; padding: 2rem; }
    </style>
</head>
<body>

<header>
    <h1>Dashboard</h1>
    <button id="signOutBtn" class="signOut">Sign Out</button>
</header>

<nav>
    <a href="#">Dashboard</a>
    <a href="compare.html">Compare</a>
    <a href="power.html">Add / Edit Power</a>
</nav>

<main>
    <section class="section">
        <h2>ðŸš€ Player Power Leaderboard</h2>
        <div class="leaderboard">
            <div id="loadingMessage">Loading player data...</div>
            <table id="leaderboardTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="rank">Rank</th>
                        <th>Player</th>
                        <th style="text-align: right;">Latest Power</th>
                        <th style="text-align: center;">Date</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    </tbody>
            </table>
        </div>
    </section>
</main>

<script>
    // Firebase config (Use your actual configuration)
    const firebaseConfig = {
      apiKey: "AIzaSyAyhGftf_DfotmvL4iLx60NT98BjkbG6DM",
      authDomain: "powercompare-bafd9.firebaseapp.com",
      projectId: "powercompare-bafd9",
      storageBucket: "powercompare-bafd9.firebasestorage.app",
      messagingSenderId: "768897803088",
      appId: "1:768897803088:web:ff55aed87037cef6720255",
      measurementId: "G-09ENH5L0VG"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentUserUid = null;

    // Utility function to format numbers with commas
    const formatNumber = (num) => {
        if (isNaN(num)) return 0;
        return Math.round(num).toLocaleString();
    };

    // --- Initialization and Auth ---

    auth.onAuthStateChanged(user => {
        if (!user) {
            location.href = "login.html";
        } else {
            currentUserUid = user.uid;
            loadLeaderboardData();
        }
    });

    document.getElementById("signOutBtn").onclick = () => auth.signOut().then(() => location.href = "login.html");
    
    // --- Data Loading ---

    /** Fetches all player entries and processes them for the leaderboard. */
    async function loadLeaderboardData() {
        if (!currentUserUid) return;

        const loadingMessage = document.getElementById('loadingMessage');
        const leaderboardTable = document.getElementById('leaderboardTable');
        const leaderboardBody = document.getElementById('leaderboardBody');

        loadingMessage.style.display = 'block';
        leaderboardTable.style.display = 'none';
        leaderboardBody.innerHTML = '';

        try {
            const snapshot = await db.collection('powers').doc(currentUserUid).collection('entries')
                                     .orderBy('name', 'asc').orderBy('date', 'desc').get();
            
            const latestEntries = {};

            snapshot.forEach(doc => {
                const data = doc.data();
                const name = data.name;
                const power = data.power || 0;
                const date = data.date;

                // Only store the latest entry for each player name
                // Since we ordered by date descending, the first entry encountered for a player is the latest.
                if (!latestEntries[name]) {
                    latestEntries[name] = {
                        name: name,
                        power: power,
                        date: date
                    };
                }
            });

            // Convert map to array and sort by power descending for ranking
            let rankedPlayers = Object.values(latestEntries);
            rankedPlayers.sort((a, b) => b.power - a.power);

            renderLeaderboard(rankedPlayers);

        } catch (error) {
            console.error("Error loading leaderboard data:", error);
            loadingMessage.textContent = "Error loading data. Please try again or check connection.";
        }
    }

    /** Renders the ranked player data into the table. */
    function renderLeaderboard(players) {
        const leaderboardBody = document.getElementById('leaderboardBody');
        const loadingMessage = document.getElementById('loadingMessage');
        const leaderboardTable = document.getElementById('leaderboardTable');

        if (players.length === 0) {
            loadingMessage.textContent = "No player data found. Go to 'Add / Edit Power' to start tracking.";
            loadingMessage.style.display = 'block';
            leaderboardTable.style.display = 'none';
            return;
        }

        let html = '';
        players.forEach((player, index) => {
            const rank = index + 1;
            const dateDisplay = new Date(player.date).toLocaleDateString('en-US', {
                year: 'numeric', month: 'numeric', day: 'numeric'
            });

            html += `
                <tr>
                    <td class="rank">${rank}</td>
                    <td>${player.name}</td>
                    <td class="power-val" style="text-align: right;">${formatNumber(player.power)}</td>
                    <td style="text-align: center; font-size: 0.85rem; color: #64748b;">${dateDisplay}</td>
                </tr>
            `;
        });

        leaderboardBody.innerHTML = html;
        loadingMessage.style.display = 'none';
        leaderboardTable.style.display = 'table';
    }

</script>
</body>
</html>
