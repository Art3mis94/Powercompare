<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Tracker â€” Add/Edit Players (Local)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600,700&display=swap" rel="stylesheet">
<style>
body { font-family: Inter,sans-serif; margin:0; background:#f8fafc; color:#1e293b; }
header { background:#1e40af; color:#fff; padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center;}
header h1 { margin:0; font-size:1.25rem; }
nav { display:flex; justify-content:center; gap:10px; padding:0.75rem; background:#e2e8f0; }
nav a { color:#fff; text-decoration:none; padding:.6rem 1rem; background:#3b82f6; border-radius:6px; font-weight:600; }
nav a:hover { opacity:.9; transform:translateY(-1px); }
main { max-width:900px; margin:1rem auto; padding:0 1rem; display:grid; gap:1rem; grid-template-columns:1fr 1fr; }
.section { background:#fff; padding:1rem; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
.input, .date-input { width:100%; padding:.5rem; border:1px solid #ccc; border-radius:8px; font-size:.95rem; margin-bottom:.5rem; }
.button { padding:.5rem .8rem; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
.button.save { background:#10b981; color:#fff; }
.button.delete { background:#ef4444; color:#fff; }
.button.cancel { background:#6b7280; color:#fff; }
.players-list { list-style:none; padding:0; margin:0; max-height:250px; overflow:auto; }
.players-list li { display:flex; justify-content:space-between; padding:.4rem .6rem; border-bottom:1px solid #eee; cursor:pointer; }
.players-list li.selected { background:#dbeafe; }
</style>
</head>
<body>

<header>
  <h1>Power Tracker</h1>
  </header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="compare.html">Compare</a>
</nav>

<main>
    <p style="grid-column: 1 / span 2; text-align:center; font-style:italic; color:#64748b; margin-top:0;">Data is stored locally in your browser.</p>
  <section class="section">
    <h2>Players</h2>
    <input id="playerNameInput" class="input" placeholder="Enter player name">
    <div style="display:flex; gap:.5rem; margin-bottom:.5rem;">
      <button id="addPlayerBtn" class="button save">Add Player</button>
      <button id="deletePlayerBtn" class="button delete">Delete Selected</button>
    </div>
    <ul id="playersList" class="players-list"></ul>
  </section>

  <section class="section">
    <h2>Add / Edit Power Entry</h2>
    <input type="date" id="entryDate" class="date-input">
    <input type="number" id="entryPower" class="input" placeholder="Power">
    <div style="display:flex; gap:.5rem;">
      <button id="saveEntryBtn" class="button save">Save Entry</button>
      <button id="deleteEntryBtn" class="button delete">Delete Entry</button>
    </div>
    <ul id="entriesList" class="players-list"></ul>
  </section>
</main>

<script>
// Key for localStorage
const LOCAL_STORAGE_KEY = 'localPowerTrackerData';

// Mock data structure to initialize localStorage if empty
const initialData = [
  // Example data entry: { player: 'Player Name', power: 123456, date: 'YYYY-MM-DD' }
  { player: 'Alpha', power: 150000, date: '2025-12-02' },
  { player: 'Beta', power: 120000, date: '2025-12-02' },
];

// Global state variables
let allEntries = {}; // Stores all entries keyed by player name
let selectedPlayer = null;
let selectedEntryId = null; // Used to identify the entry being edited/deleted

// Element references
const playerNameInput = document.getElementById('playerNameInput');
const addPlayerBtn = document.getElementById('addPlayerBtn');
const deletePlayerBtn = document.getElementById('deletePlayerBtn');
const playersList = document.getElementById('playersList');

const entryDate = document.getElementById('entryDate');
const entryPower = document.getElementById('entryPower');
const saveEntryBtn = document.getElementById('saveEntryBtn');
const deleteEntryBtn = document.getElementById('deleteEntryBtn');
const entriesList = document.getElementById('entriesList');


// --- Utility and Data Functions ---

/**
 * Loads data from localStorage, initializes if empty, and groups by player.
 * @returns {Array} The loaded and parsed array of power entries.
 */
function loadLocalData() {
    const dataString = localStorage.getItem(LOCAL_STORAGE_KEY);
    if (!dataString) {
        // Initialize with mock data if no data exists
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(initialData));
        return initialData;
    }
    return JSON.parse(dataString);
}

/**
 * Saves the current entries array back to localStorage.
 * @param {Array} entries - The array of power entries to save.
 */
function saveLocalData(entries) {
    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(entries));
}

/**
 * Generates a stable unique ID for a data entry based on player and date.
 * This replaces Firestore document IDs.
 * @param {string} player - The player name.
 * @param {string} date - The date (YYYY-MM-DD).
 * @returns {string} The unique ID.
 */
function generateEntryId(player, date) {
    return `${player}_${date}`;
}

/**
 * Reads all entries from local storage, groups them by player, and triggers rendering.
 */
function loadAllEntries() {
    const rawData = loadLocalData();
    allEntries = {};
    const uniquePlayers = new Set();
    
    // Grouping and adding unique ID
    rawData.forEach(data => {
        // Ensure date is standardized (e.g., YYYY-MM-DD)
        const date = data.date?.substring(0, 10);
        if (!date || !data.player) return;

        data.id = generateEntryId(data.player, date);
        data.date = date; 

        uniquePlayers.add(data.player);
        if (!allEntries[data.player]) allEntries[data.player] = [];
        allEntries[data.player].push(data);
    });
    
    // Sort entries for display
    Object.keys(allEntries).forEach(player => {
        allEntries[player].sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort newest first
    });
    
    renderPlayersList(Array.from(uniquePlayers).sort());
}


// --- Rendering Functions ---

function renderPlayersList(names) {
    playersList.innerHTML = "";
    // Automatically select the first player if none is selected
    if (!selectedPlayer && names.length > 0) {
        selectedPlayer = names[0];
    } else if (names.length === 0) {
        selectedPlayer = null;
    }

    names.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        li.dataset.name = name;
        if (selectedPlayer === name) {
            li.classList.add("selected");
        }
        playersList.appendChild(li);
    });
    renderEntries();
}

function renderEntries() {
    entriesList.innerHTML = "";
    if (!selectedPlayer) {
        // Clear inputs and state if no player is selected
        entryDate.value = '';
        entryPower.value = '';
        selectedEntryId = null;
        return entriesList.innerHTML = '<li style="color:#555">Select a player to see entries</li>';
    }
    
    const entries = allEntries[selectedPlayer] || [];
    if (entries.length === 0) {
        return entriesList.innerHTML = '<li style="color:#555">No entries yet. Add one below.</li>';
    }

    entries.forEach(e => {
        const li = document.createElement("li");
        li.textContent = `${e.date}: ${Number(e.power).toLocaleString()} Power`;
        li.dataset.id = e.id;
        if (selectedEntryId === e.id) {
            li.classList.add("selected");
        }
        entriesList.appendChild(li);
    });
    
    // Reset date/power inputs after rendering entries
    entryDate.value = new Date().toISOString().substring(0, 10);
    entryPower.value = '';
    selectedEntryId = null; 
}


// --- Event Handlers (CRUD Operations) ---

addPlayerBtn.addEventListener("click", () => {
    const name = playerNameInput.value.trim();
    if (!name) return alert("Enter a valid player name.");
    
    // Check if player already exists
    if (Object.keys(allEntries).includes(name)) {
        selectedPlayer = name;
        playerNameInput.value = "";
        loadAllEntries(); // Refresh to select existing player
        return;
    }

    // Add a placeholder entry (Power: 0) for the new player
    const today = new Date().toISOString().substring(0, 10);
    const newEntry = { player: name, date: today, power: 0 };

    const rawData = loadLocalData();
    rawData.push(newEntry);
    saveLocalData(rawData);

    selectedPlayer = name;
    playerNameInput.value = "";
    loadAllEntries();
});

deletePlayerBtn.addEventListener("click", () => {
    if (!selectedPlayer) return alert("Select a player to delete.");
    if (!confirm(`Are you sure you want to delete player "${selectedPlayer}" and ALL of their entries?`)) return;

    // Filter out all entries for the selected player
    let rawData = loadLocalData();
    rawData = rawData.filter(e => e.player !== selectedPlayer);
    saveLocalData(rawData);

    // Reset state
    selectedPlayer = null;
    selectedEntryId = null;
    loadAllEntries();
});

playersList.addEventListener("click", e => {
    const li = e.target.closest("li");
    if (!li) return;
    
    // Unselect all, select current
    playersList.querySelectorAll('li').forEach(i => i.classList.remove("selected"));
    li.classList.add("selected");

    selectedPlayer = li.dataset.name;
    selectedEntryId = null;
    renderEntries();
});

saveEntryBtn.addEventListener("click", () => {
    if (!selectedPlayer) return alert("Select a player first.");
    const date = entryDate.value;
    const power = Number(entryPower.value);

    if (!date || power < 0 || isNaN(power)) return alert("Enter a valid date and a non-negative power value.");

    const entryId = generateEntryId(selectedPlayer, date);
    const newEntry = { player: selectedPlayer, date: date, power: power };

    let rawData = loadLocalData();
    
    let entryExists = false;
    for (let i = 0; i < rawData.length; i++) {
        // If an entry exists for the same player and date, update it
        if (generateEntryId(rawData[i].player, rawData[i].date) === entryId) {
            rawData[i].power = power;
            entryExists = true;
            break;
        }
    }
    
    if (!entryExists) {
        // If it's a new entry (new date for this player), add it
        rawData.push(newEntry);
    }
    
    saveLocalData(rawData);
    
    // Clear inputs and refresh view
    entryDate.value = new Date().toISOString().substring(0, 10);
    entryPower.value = '';
    selectedEntryId = null;
    loadAllEntries();
});

deleteEntryBtn.addEventListener("click", () => {
    if (!selectedEntryId) return alert("Select an entry to delete.");
    if (!confirm("Are you sure you want to delete this specific power entry?")) return;

    // Filter out the entry with the matching unique ID (player_date)
    let rawData = loadLocalData();
    rawData = rawData.filter(e => generateEntryId(e.player, e.date) !== selectedEntryId);
    saveLocalData(rawData);

    // Reset state
    selectedEntryId = null;
    entryDate.value = new Date().toISOString().substring(0, 10);
    entryPower.value = '';
    loadAllEntries();
});

entriesList.addEventListener("click", e => {
    const li = e.target.closest("li");
    if (!li || !li.dataset.id) return;
    
    entriesList.querySelectorAll('li').forEach(i => i.classList.remove("selected"));
    li.classList.add("selected");
    
    selectedEntryId = li.dataset.id;
    
    // Find the corresponding data object
    const data = allEntries[selectedPlayer]?.find(en => en.id === selectedEntryId);
    
    if (data) {
        entryDate.value = data.date;
        entryPower.value = Number(data.power);
    }
});


// Initial Load
document.addEventListener('DOMContentLoaded', () => {
    // Set default date to today
    entryDate.value = new Date().toISOString().substring(0, 10);
    loadAllEntries();
});
</script>
</body>
</html>
