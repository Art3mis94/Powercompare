<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Manager â€” Add/Edit Entries</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
    :root{--bg:#f8fafc;--text:#1e293b;--card:#ffffff;--accent:#3b82f6;--muted:#475569;--success:#10b981;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:all .25s;}
    header{background:#1e40af;color:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.08);}
    header h1{margin:0;font-size:1.25rem;font-weight:600;}
    button.signOut{background:#3b82f6;border:none;color:#fff;padding:.45rem .7rem;border-radius:8px;cursor:pointer;font-weight:600;}
    nav{display:flex;justify-content:center;gap:10px;padding:0.75rem;background:#e2e8f0;}
    nav a{color:#fff;text-decoration:none;padding:.6rem 1rem;background:var(--accent);border-radius:6px;font-weight:600;}
    nav a:hover{opacity:.95;transform:translateY(-1px);}
    .main-wrap{max-width:1000px;margin:1.25rem auto;padding:0 1rem;display:grid;gap:1rem;grid-template-columns:1fr 1fr;align-items:start;}
    .section{background:var(--card);padding:1rem;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.04);}
    .section h2{margin:0 0 .75rem;font-size:1.05rem;}
    .form-row{display:flex;gap:.5rem;flex-wrap:wrap;}
    .input,.select{width:100%;padding:.5rem;border-radius:8px;border:1px solid #e2e8f0;font-size:0.95rem;}
    .button-row{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem;}
    .btn{padding:.55rem .9rem;border-radius:8px;border:0;color:#fff;font-weight:600;cursor:pointer;}
    .btn.save{background:var(--success)}.btn.save:hover{background:#059669}
    .btn.cancel{background:#6b7280}.btn.cancel:hover{background:#4b5563}
    .btn.delete{background:var(--danger)}.btn.delete:hover{background:#dc2626}
    .small-btn{padding:.35rem .6rem;font-size:.85rem;border-radius:6px;}
    .players-list{margin:0;padding:0;list-style:none;max-height:450px;overflow-y:auto;}
    .players-list li{display:flex;align-items:center;justify-content:space-between;padding:.5rem;border-radius:8px;margin-bottom:.45rem;background:linear-gradient(180deg,rgba(0,0,0,0.01),transparent);box-shadow:0 1px 0 rgba(2,6,23,0.03);cursor:pointer;}
    .players-list li:hover{background:rgba(59,130,246,0.05);}
    .players-list .name{font-weight:600;flex:1;}
    .players-list .actions button{margin-left:8px;}
    .select-group{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.6rem;}
    .select-group label{font-weight:500;color:var(--muted);display:block;}
    .player-entry-item{padding:.5rem;border-radius:8px;border:1px solid #e2e8f0;margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center;}
    .player-entry-item:hover{background:#f1f5f9;}
    .player-entry-item.selected{border-color:var(--accent);background:#eff6ff;}
    .player-entry-item .date{font-weight:600;}
    .player-entry-item .power{font-size:0.9rem;color:var(--muted);}
    @media (max-width:900px){.main-wrap{grid-template-columns:1fr;}}
</style>
</head>
<body>
  <header>
    <h1>Power Manager</h1>
    <button id="signOutBtn" class="signOut">Sign Out</button>
  </header>

  <nav>
    <a href="index.html">Dashboard</a>
    <a href="compare.html">Compare</a>
    <a href="#">Add / Edit Power</a>
  </nav>

  <main class="main-wrap">
    <section class="section" id="playersSection">
      <h2>Player Management</h2>
      <form id="playerForm" autocomplete="off">
        <div class="form-row">
          <input id="playerNameInput" placeholder="Enter new player name" class="input" />
        </div>
        <div class="button-row">
          <button type="submit" class="btn save" id="playerAddBtn">Add Player</button>
          <button type="button" class="btn cancel" id="playerCancelBtn">Clear</button>
        </div>
      </form>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f7"/>
      <h3 style="margin:.25rem 0 .6rem 0">Players (Click name to view/edit entries)</h3>
      <ul class="players-list" id="playersList"></ul>
    </section>

    <section class="section" id="statsSection">
      <h2>Add / Edit Entry</h2>
      
      <div>
        <label class="muted">Selected Player</label>
        <div id="selectedPlayerDisplay" style="padding:.5rem;background:#f1f5f9;border-radius:8px;font-weight:600;">â€”</div>
      </div>

      <div class="select-group">
        <div>
            <label for="dateInput">Date</label>
            <input type="date" id="dateInput" class="input">
        </div>
        <div>
            <label for="powerInput">Power</label>
            <input type="number" id="powerInput" placeholder="Enter power value" class="input">
        </div>
      </div>
      
      <div style="margin-top:1rem;">
        <h3 style="margin:0 0 .5rem 0; font-size: 0.95rem;">Existing Entries for <span id="entriesPlayerName">â€”</span> (Click to Edit)</h3>
        <div id="entriesList" style="max-height: 200px; overflow-y: auto;">
            <p id="noEntriesMessage" style="text-align:center; color:var(--muted); font-size:0.9rem; margin:1rem 0;">No entries for this player yet.</p>
        </div>
      </div>

      <input type="hidden" id="editDocId">

      <div class="button-row" style="margin-top:.8rem">
        <button class="btn save" id="statsSaveBtn">Save/Update Power</button>
        <button class="btn delete" id="statsDeleteBtn" disabled>Delete Entry</button>
      </div>
      <div class="button-row">
        <button class="btn cancel" id="clearFormBtn">Clear Form</button>
      </div>
    </section>
  </main>

  <script>
    // Firebase config (Use your actual configuration)
    const firebaseConfig = {
      apiKey: "AIzaSyAyhGftf_DfotmvL4iLx60NT98BjkbG6DM",
      authDomain: "powercompare-bafd9.firebaseapp.com",
      projectId: "powercompare-bafd9",
      storageBucket: "powercompare-bafd9.firebasestorage.app",
      messagingSenderId: "768897803088",
      appId: "1:768897803088:web:ff55aed87037cef6720255",
      measurementId: "G-09ENH5L0VG"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Global state
    let currentUserUid = null;
    let currentPlayer = null;
    let allPlayersData = {}; 

    // --- DOM Elements ---
    const E = {
        playerNameInput: document.getElementById('playerNameInput'),
        playersList: document.getElementById('playersList'),
        selectedPlayerDisplay: document.getElementById('selectedPlayerDisplay'),
        entriesPlayerName: document.getElementById('entriesPlayerName'),
        entriesList: document.getElementById('entriesList'),
        dateInput: document.getElementById('dateInput'),
        powerInput: document.getElementById('powerInput'),
        editDocId: document.getElementById('editDocId'),
        statsSaveBtn: document.getElementById('statsSaveBtn'),
        statsDeleteBtn: document.getElementById('statsDeleteBtn'),
        noEntriesMessage: document.getElementById('noEntriesMessage')
    };

    // --- Initialization and Auth ---

    auth.onAuthStateChanged(user => {
        if (!user) {
            location.href = "login.html"; 
        } else {
            currentUserUid = user.uid;
            E.dateInput.valueAsDate = new Date(); 
            // ðŸ’¡ This is the critical call that loads the player list from Firebase
            loadAllPlayerNames();
        }
    });

    document.getElementById("signOutBtn").onclick = () => auth.signOut().then(() => location.href = "login.html");
    
    // --- Data Loading and Player List Rendering ---

    /** Fetches unique player names for the list. */
    async function loadAllPlayerNames() {
        if (!currentUserUid) return;

        const snapshot = await db.collection('powers').doc(currentUserUid).collection('entries')
                                 .orderBy('name', 'asc').orderBy('date', 'desc').get();
        
        allPlayersData = {};
        const uniqueNames = new Set();

        snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id; 
            uniqueNames.add(data.name);
            if (!allPlayersData[data.name]) allPlayersData[data.name] = [];
            allPlayersData[data.name].push(data);
        });

        renderPlayersList(Array.from(uniqueNames));

        if (currentPlayer) selectPlayer(currentPlayer, { skipReload: true });
    }

    /** Renders the list of selectable players. */
    function renderPlayersList(names) {
        if (!names.length) {
            E.playersList.innerHTML = '<li style="color:var(--muted);padding:.6rem">No players added yet.</li>';
            return;
        }
        E.playersList.innerHTML = names.map(name => {
            const isSelected = name === currentPlayer ? 'style="background:rgba(59,130,246,0.1); border: 1px solid var(--accent);"' : '';
            return `<li data-player="${name}" ${isSelected}>
                        <span class="name" data-action="select">${name}</span>
                        <span class="actions">
                            <button class="btn delete small-btn" data-action="delete-player">Delete</button>
                        </span>
                    </li>`;
        }).join('');
    }

    // --- Player Management Actions ---

    /** Handles adding a new player (only adds the name to the data structure) */
    document.getElementById('playerForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const name = E.playerNameInput.value.trim();
        if (!name) return alert('Please enter a player name.');
        
        if (Object.keys(allPlayersData).some(n => n.toLowerCase() === name.toLowerCase())) {
            alert('A player with this name already exists.');
            return;
        }

        // Add a placeholder entry
        await db.collection('powers').doc(currentUserUid).collection('entries').add({
            name: name,
            power: 0,
            date: new Date().toISOString().substring(0, 10) + 'T00:00:00.000Z'
        });

        E.playerNameInput.value = '';
        await loadAllPlayerNames(); 
        selectPlayer(name);
    });

    document.getElementById('playerCancelBtn').onclick = () => E.playerNameInput.value = '';

    /** Handles player selection and deletion from the list (delegated event) */
    E.playersList.addEventListener('click', (ev) => {
        const li = ev.target.closest('li[data-player]');
        if (!li) return;
        const name = li.getAttribute('data-player');
        
        if (ev.target.dataset.action === 'select' || ev.target.classList.contains('name')) {
            selectPlayer(name);
        } else if (ev.target.dataset.action === 'delete-player') {
            deletePlayerAndData(name);
        }
    });

    /** Deletes all entries associated with a player name. */
    async function deletePlayerAndData(name) {
        if (!confirm(`Are you sure you want to delete the player "${name}" and ALL their power entries? This cannot be undone.`)) return;

        const batch = db.batch();
        const entriesToDelete = allPlayersData[name] || [];
        
        if (entriesToDelete.length > 0) {
            entriesToDelete.forEach(entry => {
                const docRef = db.collection('powers').doc(currentUserUid).collection('entries').doc(entry.id);
                batch.delete(docRef);
            });
            await batch.commit();
        }

        alert(`Player "${name}" and all their entries have been deleted.`);
        
        if (currentPlayer === name) selectPlayer(null);
        await loadAllPlayerNames();
    }

    // --- Stats / Power Entry Logic ---

    /** Selects a player and loads their existing entries. */
    function selectPlayer(name, options = {}) {
        currentPlayer = name;
        E.selectedPlayerDisplay.textContent = name || 'â€”';
        E.entriesPlayerName.textContent = name || 'â€”';
        
        E.dateInput.valueAsDate = new Date();
        E.powerInput.value = '';
        E.editDocId.value = '';
        E.statsDeleteBtn.disabled = true;
        E.statsSaveBtn.textContent = 'Save/Update Power';

        if (name) {
            renderEntriesList();
        } else {
            E.entriesList.innerHTML = '<p id="noEntriesMessage" style="text-align:center; color:var(--muted); font-size:0.9rem; margin:1rem 0;">Select a player to view entries.</p>';
        }

        if (!options.skipReload) {
            const names = Object.keys(allPlayersData);
            renderPlayersList(names);
        }
    }

    /** Renders the list of date/power entries for the selected player. */
    function renderEntriesList() {
        const entries = allPlayersData[currentPlayer] || [];
        
        if (entries.length === 0) {
            E.entriesList.innerHTML = '<p id="noEntriesMessage" style="text-align:center; color:var(--muted); font-size:0.9rem; margin:1rem 0;">No entries for this player yet.</p>';
            return;
        }

        E.entriesList.innerHTML = entries.map(entry => {
            const dateDisplay = new Date(entry.date).toLocaleDateString();
            const powerDisplay = (entry.power || 0).toLocaleString();
            
            return `
                <div class="player-entry-item" data-doc-id="${entry.id}" onclick="loadEntryForEdit('${entry.id}')">
                    <span class="date">${dateDisplay}</span>
                    <span class="power">${powerDisplay} Power</span>
                </div>
            `;
        }).join('');
    }

    /** Loads a specific entry into the form for editing. */
    window.loadEntryForEdit = (docId) => {
        const entries = allPlayersData[currentPlayer] || [];
        const entry = entries.find(e => e.id === docId);

        if (!entry) return;

        document.querySelectorAll('.player-entry-item').forEach(el => el.classList.remove('selected'));
        document.querySelector(`.player-entry-item[data-doc-id="${docId}"]`).classList.add('selected');
        
        E.dateInput.value = entry.date.substring(0, 10);
        E.powerInput.value = entry.power;
        E.editDocId.value = docId;
        
        E.statsDeleteBtn.disabled = false;
        E.statsSaveBtn.textContent = 'Update Power';
    };

    /** Handles saving or updating the power entry. */
    E.statsSaveBtn.onclick = async () => {
        if (!currentPlayer) return alert('Please select a player first.');

        const power = parseFloat(E.powerInput.value);
        let date = E.dateInput.value;
        const docId = E.editDocId.value;

        if (isNaN(power) || power <= 0) return alert('Enter a valid power value.');
        if (!date) {
            date = new Date().toISOString().substring(0, 10);
            E.dateInput.value = date;
        }

        const isoDate = date + 'T00:00:00.000Z';
        
        const dataToSave = { 
            name: currentPlayer, 
            power: power, 
            date: isoDate 
        };
        
        const collectionRef = db.collection('powers').doc(currentUserUid).collection('entries');

        if (docId) {
            await collectionRef.doc(docId).update(dataToSave);
            alert('Entry updated successfully!');
        } else {
            await collectionRef.add(dataToSave);
            alert('New entry added successfully!');
        }

        await loadAllPlayerNames(); 
        selectPlayer(currentPlayer, { skipReload: true }); 
    };

    /** Handles deleting the currently selected entry. */
    E.statsDeleteBtn.onclick = async () => {
        const docId = E.editDocId.value;
        if (!docId) return;

        if (!confirm('Are you sure you want to delete this specific entry?')) return;

        await db.collection('powers').doc(currentUserUid).collection('entries').doc(docId).delete();
        alert('Entry deleted.');

        await loadAllPlayerNames();
        selectPlayer(currentPlayer, { skipReload: true });
    };

    /** Clears the stats form only. */
    document.getElementById('clearFormBtn').onclick = () => {
        E.dateInput.valueAsDate = new Date();
        E.powerInput.value = '';
        E.editDocId.value = '';
        E.statsDeleteBtn.disabled = true;
        E.statsSaveBtn.textContent = 'Save/Update Power';
        document.querySelectorAll('.player-entry-item').forEach(el => el.classList.remove('selected'));
    };

  </script>
</body>
</html>
