<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Tracker â€” Add/Edit Players</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600,700&display=swap" rel="stylesheet">
<style>
/* ... (Existing styles remain the same) ... */
body { font-family: Inter,sans-serif; margin:0; background:#f8fafc; color:#1e293b; }
header { background:#1e40af; color:#fff; padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center;}
header h1 { margin:0; font-size:1.25rem; }
nav { display:flex; justify-content:center; gap:10px; padding:0.75rem; background:#e2e8f0; }
nav a { color:#fff; text-decoration:none; padding:.6rem 1rem; background:#3b82f6; border-radius:6px; font-weight:600; }
nav a:hover { opacity:.9; transform:translateY(-1px); }
main { max-width:900px; margin:1rem auto; padding:0 1rem; display:grid; gap:1rem; grid-template-columns:1fr 1fr; }
.section { background:#fff; padding:1rem; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
.input { width:100%; padding:.5rem; border:1px solid #ccc; border-radius:8px; font-size:.95rem; margin-bottom:.5rem; }
.button { padding:.5rem .8rem; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
.button.save { background:#10b981; color:#fff; }
.button.delete { background:#ef4444; color:#fff; }
.button.cancel { background:#6b7280; color:#fff; }
.players-list { list-style:none; padding:0; margin:0; max-height:250px; overflow:auto; }
.players-list li { display:flex; justify-content:space-between; padding:.4rem .6rem; border-bottom:1px solid #eee; cursor:pointer; }
.players-list li.selected { background:#dbeafe; }
.date-input { width:100%; padding:.5rem; border:1px solid #ccc; border-radius:8px; margin-bottom:.5rem; }
</style>
</head>
<body>

<header>
  <h1>Power Tracker</h1>
</header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="compare.html">Compare</a>
</nav>

<main>
  <section class="section">
    <h2>Players</h2>
    <input id="playerNameInput" class="input" placeholder="Enter player name">
    <div style="display:flex; gap:.5rem; margin-bottom:.5rem;">
      <button id="addPlayerBtn" class="button save">Add Player</button>
      <button id="deletePlayerBtn" class="button delete">Delete Selected</button>
    </div>
    <ul id="playersList" class="players-list"></ul>
  </section>

  <section class="section">
    <h2>Add Power Entry</h2>
    <input type="date" id="entryDate" class="date-input">
    <input type="number" id="entryPower" class="input" placeholder="Power">
    <div style="display:flex; gap:.5rem;">
      <button id="saveEntryBtn" class="button save">Save Entry</button>
      <button id="deleteEntryBtn" class="button delete">Delete Entry</button>
    </div>
    <ul id="entriesList" class="players-list"></ul>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// --- Your Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyAyhGftf_DfotmvL4iLx60NT98BjkbG6DM",
  authDomain: "powercompare-bafd9.firebaseapp.com",
  projectId: "powercompare-bafd9",
  storageBucket: "powercompare-bafd9.firebasestorage.app",
  messagingSenderId: "768897803088",
  appId: "1:768897803088:web:ff55aed87037cef6720255",
  measurementId: "G-09ENH5L0VG"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let uid = null;

// UI elements
const playerNameInput = document.getElementById('playerNameInput');
const addPlayerBtn = document.getElementById('addPlayerBtn');
const deletePlayerBtn = document.getElementById('deletePlayerBtn');
const playersList = document.getElementById('playersList');

const entryDate = document.getElementById('entryDate');
const entryPower = document.getElementById('entryPower');
const saveEntryBtn = document.getElementById('saveEntryBtn');
const deleteEntryBtn = document.getElementById('deleteEntryBtn');
const entriesList = document.getElementById('entriesList');

let selectedPlayer = null;
let selectedEntryId = null;
let allEntriesData = {}; 


// ðŸš€ ------------------------------------------ ðŸš€
// ðŸš€ TEMPORARY MIGRATION FUNCTION (REMOVE AFTER USE) ðŸš€
// ----------------------------------------------------
async function migrateOldData(uid) {
    if (!uid) return;
    
    // Old Path: /users/{uid}/entries
    const oldEntriesRef = db.collection("users").doc(uid).collection("entries");
    // New Path: /powers/{uid}/entries
    const newEntriesRef = db.collection("powers").doc(uid).collection("entries");
    
    console.log(`Starting migration for user: ${uid}`);
    
    try {
        const snapshot = await oldEntriesRef.get();
        const totalEntries = snapshot.docs.length;

        if (totalEntries === 0) {
            console.log("âœ… No old entries found in /users/...");
            return;
        }

        console.warn(`Found ${totalEntries} old entries. Migrating now...`);

        let batch = db.batch();
        let batchCount = 0;

        for (const doc of snapshot.docs) {
            const oldData = doc.data();
            const oldDocId = doc.id;

            // Use 'player' and 'date' to create the new ID for consistency
            const newDocId = `${oldData.player}_${oldData.date.substring(0, 10)}`;

            const newData = {
                player: oldData.player,
                date: oldData.date.substring(0, 10), 
                power: oldData.power || 0,
            };

            // 1. Set the new document (COPY)
            batch.set(newEntriesRef.doc(newDocId), newData);
            
            // 2. Delete the old document (MERGE/DELETE)
            batch.delete(oldEntriesRef.doc(oldDocId));

            batchCount++;
            
            if (batchCount >= 490) {
                await batch.commit();
                console.log(`Committed batch: ${batchCount} operations.`);
                batch = db.batch();
                batchCount = 0;
            }
        }

        if (batchCount > 0) {
            await batch.commit();
        }

        console.log(`ðŸŽ‰ Migration complete! ${totalEntries} entries moved to /powers/...`);
        
    } catch (error) {
        console.error("âš ï¸ Migration failed:", error);
    }
}
// ðŸš€ ------------------------------------------ ðŸš€


// --- Wait for login ---
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  uid = user.uid;
  
  // ðŸ’¡ TEMPORARY: RUN THE MIGRATION FUNCTION ONCE!
  // Check console for "Migration complete" message.
  migrateOldData(uid); 

  loadAllEntries(); 
});

// ----------------------
// FIREBASE LOADERS (Rest of the script is unchanged)
// ----------------------

function loadAllEntries() {
  db.collection("powers").doc(uid).collection("entries")
    .orderBy("date", "desc") 
    .onSnapshot(snapshot => {
      allEntriesData = {};
      const uniquePlayers = new Set();
      
      snapshot.forEach(doc => {
        const data = doc.data();
        data.id = doc.id;
        // NOTE: If using the old /users/ structure, the player field might have been 'name' instead of 'player'.
        // Assuming your working Dashboard uses the 'player' field now.
        uniquePlayers.add(data.player); 

        if (!allEntriesData[data.player]) {
          allEntriesData[data.player] = [];
        }
        allEntriesData[data.player].push(data);
      });
      
      renderPlayersList(Array.from(uniquePlayers).sort());
    });
}

function renderPlayersList(names) {
    playersList.innerHTML = "";
    
    if (!selectedPlayer && names.length > 0) {
        selectedPlayer = names[0];
    }
    
    names.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        li.dataset.name = name;
        if (selectedPlayer === name) li.classList.add("selected");
        playersList.appendChild(li);
    });
    
    renderEntries(); 
}

function renderEntries() {
  entriesList.innerHTML = "";
  if (!selectedPlayer) {
    entriesList.innerHTML = '<li style="color:#555">Select a player to see entries</li>';
    return;
  }
  
  const entries = allEntriesData[selectedPlayer] || [];

  if (entries.length === 0) {
    entriesList.innerHTML = '<li style="color:#555">No entries yet</li>';
    return;
  }
  
  entries.forEach(e => {
    const li = document.createElement("li");
    li.textContent = `${e.date.substring(0, 10)}: ${Number(e.power).toLocaleString()} Power`;
    li.dataset.id = e.id;
    if (selectedEntryId === e.id) li.classList.add("selected");
    entriesList.appendChild(li);
  });
}

// ----------------------
// PLAYER EVENTS
// ----------------------
addPlayerBtn.addEventListener("click", () => {
  const name = playerNameInput.value.trim();
  if (!name) return alert("Enter name");
  
  db.collection("powers").doc(uid).collection("entries").add({
    player: name,
    date: new Date().toISOString().substring(0, 10),
    power: 0
  })
  .then(() => {
    playerNameInput.value = "";
    selectedPlayer = name; 
  });
});

deletePlayerBtn.addEventListener("click", () => {
  if (!selectedPlayer) return alert("Select player");

  if (!confirm(`Delete player "${selectedPlayer}" and all entries?`)) return;

  db.collection("powers").doc(uid).collection("entries")
    .where("player", "==", selectedPlayer)
    .get()
    .then(s => {
      const batch = db.batch();
      s.forEach(doc => batch.delete(doc.ref));
      return batch.commit();
    })
    .then(() => {
      selectedPlayer = null;
      selectedEntryId = null;
    });
});

playersList.addEventListener("click", e => {
  const li = e.target.closest("li");
  if (!li) return;
  
  playersList.querySelectorAll('li').forEach(item => item.classList.remove('selected'));
  
  selectedPlayer = li.dataset.name;
  selectedEntryId = null;
  
  li.classList.add("selected");
  renderEntries();
});

// ----------------------
// ENTRY EVENTS
// ----------------------
saveEntryBtn.addEventListener("click", () => {
  if (!selectedPlayer) return alert("Select a player");

  const date = entryDate.value;
  const power = Number(entryPower.value);
  if (!date || isNaN(power) || power < 0) return alert("Enter a valid date and non-negative power value");

  const isoDate = date.substring(0, 10);
  
  const docId = selectedEntryId || `${selectedPlayer}_${isoDate}`; 

  db.collection("powers").doc(uid).collection("entries").doc(docId)
    .set({ 
      player: selectedPlayer, 
      date: isoDate, 
      power: power 
    })
    .then(() => {
      selectedEntryId = null; 
    });
});

deleteEntryBtn.addEventListener("click", () => {
  if (!selectedEntryId) return alert("Select entry");
  
  db.collection("powers").doc(uid).collection("entries").doc(selectedEntryId).delete()
    .then(() => {
        selectedEntryId = null;
    });
});

// select entry
entriesList.addEventListener("click", e => {
  const li = e.target.closest("li");
  if (!li) return;
  
  entriesList.querySelectorAll('li').forEach(item => item.classList.remove('selected'));
  
  selectedEntryId = li.dataset.id;
  li.classList.add("selected");
  
  const data = allEntriesData[selectedPlayer].find(entry => entry.id === selectedEntryId);
  if (data) {
      entryDate.value = data.date.substring(0, 10);
      entryPower.value = data.power;
  }
});
</script>
</body>
</html>
