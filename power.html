<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Tracker â€” Add/Edit Players</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600,700&display=swap" rel="stylesheet">
<style>
body { font-family: Inter,sans-serif; margin:0; background:#f8fafc; color:#1e293b; }
header { background:#1e40af; color:#fff; padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center;}
header h1 { margin:0; font-size:1.25rem; }
nav { display:flex; justify-content:center; gap:10px; padding:0.75rem; background:#e2e8f0; }
nav a { color:#fff; text-decoration:none; padding:.6rem 1rem; background:#3b82f6; border-radius:6px; font-weight:600; }
nav a:hover { opacity:.9; transform:translateY(-1px); }
main { max-width:900px; margin:1rem auto; padding:0 1rem; display:grid; gap:1rem; grid-template-columns:1fr 1fr; }
.section { background:#fff; padding:1rem; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
.input { width:100%; padding:.5rem; border:1px solid #ccc; border-radius:8px; font-size:.95rem; margin-bottom:.5rem; }
.button { padding:.5rem .8rem; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
.button.save { background:#10b981; color:#fff; }
.button.delete { background:#ef4444; color:#fff; }
.button.cancel { background:#6b7280; color:#fff; }
.players-list { list-style:none; padding:0; margin:0; max-height:250px; overflow:auto; }
.players-list li { display:flex; justify-content:space-between; padding:.4rem .6rem; border-bottom:1px solid #eee; cursor:pointer; }
.players-list li.selected { background:#dbeafe; }
.date-input { width:100%; padding:.5rem; border:1px solid #ccc; border-radius:8px; margin-bottom:.5rem; }
</style>
</head>
<body>

<header>
  <h1>Power Tracker</h1>
</header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="compare.html">Compare</a>
</nav>

<main>
  <section class="section">
    <h2>Players</h2>
    <input id="playerNameInput" class="input" placeholder="Enter player name">
    <div style="display:flex; gap:.5rem; margin-bottom:.5rem;">
      <button id="addPlayerBtn" class="button save">Add Player</button>
      <button id="deletePlayerBtn" class="button delete">Delete Selected</button>
    </div>
    <ul id="playersList" class="players-list"></ul>
  </section>

  <section class="section">
    <h2>Add Power Entry</h2>
    <input type="date" id="entryDate" class="date-input">
    <input type="number" id="entryPower" class="input" placeholder="Power">
    <div style="display:flex; gap:.5rem;">
      <button id="saveEntryBtn" class="button save">Save Entry</button>
      <button id="deleteEntryBtn" class="button delete">Delete Entry</button>
    </div>
    <ul id="entriesList" class="players-list"></ul>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// --- Your Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyAyhGftf_DfotmvL4iLx60NT98BjkbG6DM",
  authDomain: "powercompare-bafd9.firebaseapp.com",
  projectId: "powercompare-bafd9",
  storageBucket: "powercompare-bafd9.firebasestorage.app",
  messagingSenderId: "768897803088",
  appId: "1:768897803088:web:ff55aed87037cef6720255",
  measurementId: "G-09ENH5L0VG"
};

// ðŸ’¡ INITIALIZATION IS NOW CORRECT FOR COMPAT LIBRARIES
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let uid = null;

// UI elements
const playerNameInput = document.getElementById('playerNameInput');
const addPlayerBtn = document.getElementById('addPlayerBtn');
const deletePlayerBtn = document.getElementById('deletePlayerBtn');
const playersList = document.getElementById('playersList');

const entryDate = document.getElementById('entryDate');
const entryPower = document.getElementById('entryPower');
const saveEntryBtn = document.getElementById('saveEntryBtn');
const deleteEntryBtn = document.getElementById('deleteEntryBtn');
const entriesList = document.getElementById('entriesList');

let selectedPlayer = null;
let selectedEntryId = null;

// --- Wait for login ---
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  uid = user.uid;
  loadPlayers();
});

// ----------------------
// FIREBASE LOADERS
// ----------------------
function loadPlayers() {
  db.collection("users").doc(uid).collection("players")
    .orderBy("name")
    .onSnapshot(snapshot => {
      playersList.innerHTML = "";
      snapshot.forEach(doc => {
        const name = doc.id;
        const li = document.createElement("li");
        li.textContent = name;
        li.dataset.name = name;
        // ðŸ’¡ Ensure selection state is maintained
        if (selectedPlayer === name) {
            li.classList.add("selected");
        } else if (!selectedPlayer && playersList.children.length === 0) {
            // Automatically select the first player if no one is selected
            selectedPlayer = name;
            li.classList.add("selected");
        }
        playersList.appendChild(li);
      });
      renderEntries();
    });
}

function loadEntriesForPlayer(player) {
  db.collection("users").doc(uid).collection("entries")
    .where("player", "==", player)
    .orderBy("date", "desc") // Order by descending date to show latest first
    .onSnapshot(snapshot => {
      entriesList.innerHTML = "";
      if (snapshot.empty) {
        entriesList.innerHTML = '<li style="color:#555">No entries yet</li>';
        return;
      }
      snapshot.forEach(doc => {
        const e = doc.data();
        const li = document.createElement("li");
        // Display power with comma separators
        li.textContent = `${e.date}: ${Number(e.power).toLocaleString()} Power`;
        li.dataset.id = doc.id;
        if (selectedEntryId === doc.id) li.classList.add("selected");
        entriesList.appendChild(li);
      });
    });
}

// ----------------------
// RENDER
// ----------------------
function renderEntries() {
  if (!selectedPlayer) {
    entriesList.innerHTML = '<li style="color:#555">Select a player to see entries</li>';
    return;
  }
  loadEntriesForPlayer(selectedPlayer);
}

// ----------------------
// PLAYER EVENTS
// ----------------------
addPlayerBtn.addEventListener("click", () => {
  const name = playerNameInput.value.trim();
  if (!name) return alert("Enter name");

  db.collection("users").doc(uid).collection("players").doc(name)
    .set({ name })
    .then(() => playerNameInput.value = "");
});

deletePlayerBtn.addEventListener("click", () => {
  if (!selectedPlayer) return alert("Select player");

  if (!confirm(`Delete player "${selectedPlayer}" and all entries?`)) return;

  const playerRef = db.collection("users").doc(uid).collection("players").doc(selectedPlayer);

  // delete player
  playerRef.delete();

  // delete all entries for player (No longer necessary if you use security rules, but good for cleanup)
  db.collection("users").doc(uid).collection("entries")
    .where("player", "==", selectedPlayer)
    .get()
    .then(s => s.forEach(doc => doc.ref.delete()));

  selectedPlayer = null;
  selectedEntryId = null;
});

playersList.addEventListener("click", e => {
  const li = e.target.closest("li");
  if (!li) return;
  
  // Remove selection from all list items
  playersList.querySelectorAll('li').forEach(item => item.classList.remove('selected'));
  
  selectedPlayer = li.dataset.name;
  selectedEntryId = null;
  
  // Add selection to the clicked item
  li.classList.add("selected");
  renderEntries();
});

// ----------------------
// ENTRY EVENTS
// ----------------------
saveEntryBtn.addEventListener("click", () => {
  if (!selectedPlayer) return alert("Select a player");

  const date = entryDate.value;
  const power = Number(entryPower.value);
  if (!date || !power) return alert("Enter date and power");
  
  // ðŸ’¡ Ensure date format is consistent for ID and comparison
  const id = `${selectedPlayer}_${date}`;

  db.collection("users").doc(uid).collection("entries").doc(id)
    .set({ player: selectedPlayer, date, power })
    .then(() => {
      // Clear form inputs after successful save
      entryDate.value = "";
      entryPower.value = "";
      // The loadEntriesForPlayer function uses onSnapshot, so the list will auto-update.
    });
});

deleteEntryBtn.addEventListener("click", () => {
  if (!selectedEntryId) return alert("Select entry");
  db.collection("users").doc(uid).collection("entries").doc(selectedEntryId).delete();
  selectedEntryId = null;
});

// select entry
entriesList.addEventListener("click", e => {
  const li = e.target.closest("li");
  if (!li) return;
  
  // Remove selection from all entry list items
  entriesList.querySelectorAll('li').forEach(item => item.classList.remove('selected'));
  
  selectedEntryId = li.dataset.id;
  li.classList.add("selected");
  
  // Pre-fill form with selected entry data (optional, but good UX)
  const entryData = li.textContent.split(':');
  if (entryData.length > 1) {
      entryDate.value = entryData[0].trim();
      // Use regex to remove commas and ' Power' before setting the number input
      entryPower.value = entryData[1].replace(/,/g, '').replace(' Power', '').trim();
  }
});
</script>
</body>
</html>
