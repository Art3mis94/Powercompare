<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Power Tracker â€” Add/Edit Players</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600,700&display=swap" rel="stylesheet">

<style>
body { font-family: Inter,sans-serif; margin:0; background:#f8fafc; color:#1e293b; }
header { background:#1e40af; color:#fff; padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center;}
header h1 { margin:0; font-size:1.25rem; }
nav { display:flex; justify-content:center; gap:10px; padding:0.75rem; background:#e2e8f0; }
nav a { color:#fff; text-decoration:none; padding:.6rem 1rem; background:#3b82f6; border-radius:6px; font-weight:600; }
nav a:hover { opacity:.9; transform:translateY(-1px); }
main { max-width:900px; margin:1rem auto; padding:0 1rem; display:grid; gap:1rem; grid-template-columns:1fr 1fr; }
.section { background:#fff; padding:1rem; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
.input { width:100%; padding:.5rem; border:1px solid #ccc; border-radius:8px; font-size:.95rem; margin-bottom:.5rem; }
.button { padding:.5rem .8rem; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
.button.save { background:#10b981; color:#fff; }
.button.delete { background:#ef4444; color:#fff; }
.players-list { list-style:none; padding:0; margin:0; max-height:250px; overflow:auto; }
.players-list li { display:flex; justify-content:space-between; padding:.4rem .6rem; border-bottom:1px solid #eee; cursor:pointer; }
.players-list li.selected { background:#dbeafe; }
.date-input { width:100%; padding:.5rem; border:1px solid #ccc; border-radius:8px; margin-bottom:.5rem; }
</style>
</head>
<body>

<header>
  <h1>Power Tracker</h1>
</header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="compare.html">Compare</a>
</nav>

<main>
  <!-- Player Management -->
  <section class="section">
    <h2>Players</h2>
    <input id="playerNameInput" class="input" placeholder="Enter player name">
    <div style="display:flex; gap:.5rem; margin-bottom:.5rem;">
      <button id="addPlayerBtn" class="button save">Add Player</button>
      <button id="deletePlayerBtn" class="button delete">Delete Selected</button>
    </div>
    <ul id="playersList" class="players-list"></ul>
  </section>

  <!-- Power Logging -->
  <section class="section">
    <h2>Add Power Entry</h2>
    <input type="date" id="entryDate" class="date-input">
    <input type="number" id="entryPower" class="input" placeholder="Power">
    <div style="display:flex; gap:.5rem;">
      <button id="saveEntryBtn" class="button save">Save Entry</button>
      <button id="deleteEntryBtn" class="button delete">Delete Entry</button>
    </div>
    <ul id="entriesList" class="players-list"></ul>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyAyhGftf_DfotmvL4iLx60NT98BjkbG6DM",
  authDomain: "powercompare-bafd9.firebaseapp.com",
  projectId: "powercompare-bafd9",
  storageBucket: "powercompare-bafd9.firebasestorage.app",
  messagingSenderId: "768897803088",
  appId: "1:768897803088:web:ff55aed87037cef6720255",
  measurementId: "G-09ENH5L0VG"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let uid = null;
let selectedPlayer = null;
let selectedEntryId = null;

// UI elements
const playerNameInput = document.getElementById('playerNameInput');
const addPlayerBtn = document.getElementById('addPlayerBtn');
const deletePlayerBtn = document.getElementById('deletePlayerBtn');
const playersList = document.getElementById('playersList');

const entryDate = document.getElementById('entryDate');
const entryPower = document.getElementById('entryPower');
const saveEntryBtn = document.getElementById('saveEntryBtn');
const deleteEntryBtn = document.getElementById('deleteEntryBtn');
const entriesList = document.getElementById('entriesList');

let allPlayersData = {}; // {playerId: {name, entries:[{date,power,id}] }}

// --- Auth check ---
auth.onAuthStateChanged(user => {
  if(!user) window.location.href="login.html";
  else {
    uid = user.uid;
    loadPlayers();
  }
});

// ----------------------
// LOAD PLAYERS & ENTRIES
// ----------------------
function loadPlayers() {
  db.collection("powers").doc(uid).collection("players")
    .orderBy("name").onSnapshot(snapshot => {
      allPlayersData = {};
      const playerIds = [];

      snapshot.forEach(doc => {
        allPlayersData[doc.id] = { name: doc.data().name, entries: [] };
        playerIds.push(doc.id);
      });

      // Load entries for each player
      playerIds.forEach(playerId => {
        db.collection("powers").doc(uid).collection("players")
          .doc(playerId).collection("entries")
          .orderBy("date","desc")
          .onSnapshot(esnap => {
            const entries = [];
            esnap.forEach(edoc => entries.push({...edoc.data(), id:edoc.id}));
            allPlayersData[playerId].entries = entries;
            renderPlayers();
          });
      });
    });
}

// ----------------------
// RENDER PLAYERS
// ----------------------
function renderPlayers() {
  playersList.innerHTML = "";
  Object.entries(allPlayersData).forEach(([pid, pdata]) => {
    const li = document.createElement("li");
    li.textContent = pdata.name;
    li.dataset.id = pid;
    if(selectedPlayer === pid) li.classList.add("selected");
    playersList.appendChild(li);
  });
  renderEntries();
}

// ----------------------
// RENDER ENTRIES
// ----------------------
function renderEntries() {
  entriesList.innerHTML = "";
  if(!selectedPlayer) {
    entriesList.innerHTML='<li style="color:#555">Select a player to see entries</li>';
    return;
  }
  const entries = allPlayersData[selectedPlayer].entries;
  if(entries.length===0){
    entriesList.innerHTML='<li style="color:#555">No entries yet</li>';
    return;
  }
  entries.forEach(e => {
    const li = document.createElement("li");
    li.textContent = `${e.date.substring(0,10)}: ${Number(e.power).toLocaleString()} Power`;
    li.dataset.id = e.id;
    if(selectedEntryId===e.id) li.classList.add("selected");
    entriesList.appendChild(li);
  });
}

// ----------------------
// PLAYER EVENTS
// ----------------------
addPlayerBtn.addEventListener("click", async ()=>{
  const name = playerNameInput.value.trim();
  if(!name) return alert("Enter a name");

  // Check if already exists
  const exists = Object.values(allPlayersData).some(p=>p.name===name);
  if(exists) return alert("Player already exists");

  await db.collection("powers").doc(uid).collection("players").add({name});
  playerNameInput.value="";
});

deletePlayerBtn.addEventListener("click", async ()=>{
  if(!selectedPlayer) return alert("Select a player");

  if(!confirm(`Delete player "${allPlayersData[selectedPlayer].name}" and all entries?`)) return;

  // Delete entries first
  const entriesSnap = await db.collection("powers").doc(uid)
    .collection("players").doc(selectedPlayer)
    .collection("entries").get();

  const batch = db.batch();
  entriesSnap.forEach(doc=>batch.delete(doc.ref));
  // Delete player doc
  batch.delete(db.collection("powers").doc(uid).collection("players").doc(selectedPlayer));
  await batch.commit();

  selectedPlayer = null;
  selectedEntryId = null;
});

// Select player
playersList.addEventListener("click", e=>{
  const li = e.target.closest("li");
  if(!li) return;
  selectedPlayer = li.dataset.id;
  selectedEntryId = null;
  playersList.querySelectorAll("li").forEach(i=>i.classList.remove("selected"));
  li.classList.add("selected");
  renderEntries();
});

// ----------------------
// ENTRY EVENTS
// ----------------------
saveEntryBtn.addEventListener("click", async ()=>{
  if(!selectedPlayer) return alert("Select a player");
  const date = entryDate.value;
  const power = Number(entryPower.value) || 0;
  if(!date) return alert("Enter a date");

  const docId = date; // Use date as doc ID
  await db.collection("powers").doc(uid).collection("players")
    .doc(selectedPlayer).collection("entries").doc(docId)
    .set({date, power});

  entryDate.value="";
  entryPower.value="";
});

deleteEntryBtn.addEventListener("click", async ()=>{
  if(!selectedEntryId || !selectedPlayer) return alert("Select an entry");
  await db.collection("powers").doc(uid).collection("players")
    .doc(selectedPlayer).collection("entries").doc(selectedEntryId)
    .delete();
  selectedEntryId = null;
});

// Select entry
entriesList.addEventListener("click", e=>{
  const li = e.target.closest("li");
  if(!li) return;
  selectedEntryId = li.dataset.id;
  entriesList.querySelectorAll("li").forEach(i=>i.classList.remove("selected"));
  li.classList.add("selected");

  const data = allPlayersData[selectedPlayer].entries.find(en=>en.id===selectedEntryId);
  if(data){
    entryDate.value = data.date.substring(0,10);
    entryPower.value = data.power;
  }
});
</script>

</body>
</html>